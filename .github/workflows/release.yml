name: Rust CI & Release

# ------------- è§¦å‘æ¡ä»¶ -------------
on:
  push:
    branches: [main] # push åˆ° main è§¦å‘ CI å’Œ Release PR
    tags:
      - "v*" # push æ ‡ç­¾æ—¶è§¦å‘æ„å»ºå’Œå‘å¸ƒ
  pull_request:
    branches: [main] # PR æäº¤åˆ° main åˆ†æ”¯æ—¶è§¦å‘ CI

permissions:
  contents: write # å…è®¸æ“ä½œä»£ç åº“å†…å®¹ï¼Œç”¨äº release-please å’Œ changelog
  pull-requests: write # å…è®¸åˆ›å»ºå’Œæ›´æ–° Pull Request
  issues: write # ç”¨äºå‘å¸ƒæ—¶æ·»åŠ  issue ç›¸å…³å†…å®¹ï¼ˆå¦‚æœéœ€è¦ï¼‰
  actions: write # å…è®¸åˆ›å»º release

jobs:
  # ------------------ Release Please è‡ªåŠ¨åˆ›å»º Release PR ------------------
  release-please:
    name: Generate Release PR
    runs-on: ubuntu-latest
    # åªåœ¨ push åˆ° main æ—¶è¿è¡Œï¼ˆPR è§¦å‘æ—¶ä¸ä¼šè¿è¡Œï¼‰
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Release Please Action
        uses: googleapis/release-please-action@v4
        with:
          release-type: rust # Rust é¡¹ç›®
          package-name: myapp # æ›¿æ¢æˆä½ çš„ crate åç§°ï¼Œé¡»ä¸ Cargo.toml ä¸­ä¸€è‡´
          token: ${{ secrets.GITHUB_TOKEN }}
          changelog-types: |
            [
              {"type": "feat", "section": "âœ¨ Features"},
              {"type": "fix", "section": "ğŸ› Bug Fixes"},
              {"type": "chore", "section": "ğŸ”§ Maintenance"},
              {"type": "refactor", "section": "ğŸ§¼ Refactors"},
              {"type": "docs", "section": "ğŸ“ Documentation"},
              {"type": "test", "section": "ğŸ§ª Tests"}
            ]

  # ------------------ å¤šå¹³å°æ„å»ºã€æµ‹è¯• ------------------
  build:
    name: Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - name: Cache Cargo registry and build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Check formatting (cargo fmt)
        run: cargo fmt --check

      - name: Run Clippy (static analysis)
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Build debug version
        run: cargo build --verbose

      - name: Run tests
        run: cargo test --verbose

      # ä»…åœ¨ tag æ¨é€æ—¶æ‰§è¡Œ release æ„å»ºï¼Œå‡†å¤‡å‘å¸ƒçš„äºŒè¿›åˆ¶æ–‡ä»¶
      - name: Build release & rename binary
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cargo build --release
          mkdir -p dist

          PLATFORM=""
          case "${{ runner.os }}" in
            "Windows") PLATFORM="windows" ;;
            "macOS")   PLATFORM="macos" ;;
            "Linux")   PLATFORM="linux" ;;
          esac

          OUTFILE="myapp-${PLATFORM}"
          if [ "${{ runner.os }}" = "Windows" ]; then
            mv target/release/myapp.exe "dist/${OUTFILE}.exe"
          else
            mv target/release/myapp "dist/${OUTFILE}"
          fi

      - name: Upload release artifact
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.repository.split('/')[1] }}-${{ matrix.os }}
          path: dist/*
          if-no-files-found: error

  # ------------------ å‘å¸ƒ GitHub Release ------------------
  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create GitHub Release and upload binaries
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          files: dist/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
